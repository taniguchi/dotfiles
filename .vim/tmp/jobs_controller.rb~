class Printer::JobsController < ApplicationController

  before_filter :find_job_id, :except => [:index, :create]
  after_filter :make_response_header

  def index
    jobinfo = []

    @job = Printer::Jobs.find(:all)
    @job.each do |var|
      printingInfo = {
        "printedCount" => var.printing_printed_count
      }
      jobinfolist = {
        "jobId" => var.job_id,
        "jobStatus" => var.job_state,
        "printingInfo" => printingInfo,
        "jobName" => var.job_name,
        "userName" => var.user_name
      }
      jobinfo.push(jobinfolist)
    end

    res = {
      "jobInfo" => jobinfo
    }
    render :json => res
    
  end

  def create
    # jobIdの生成
    # 今回は時間から生成　例：20130530070423(2013年5月30日7時4分23秒)
    day = Time.now
    generated_id = p day.strftime("%Y%m%d%H%M%S")

    # ジョブをDBに登録
    Printer::Jobs.new do |i|
      i.job_id = generated_id
      i.job_state = "pending"
      i.save
    end

    res = {
      "jobId" => generated_id,
      "result" => "ok",
    }

    render :json => res
  end

  def find_job_id
    @job = Printer::Jobs.find(:first, :conditions => ["job_id = ?", params[:id]])
  end

  def make_response_header
    # クロスサイトHTTPリクエストに対応
    response.headers["Access-Control-Allow-Origin"] = "*"
    response.headers["Access-Control-Allow-Methods"] = "GET,POST,PUT"
    response.headers["Access-Control-Allow-Headers"] = "X-PINGOTHER"
    response.headers["Access-Control-Max-Age"] = "1728000"
  end
end
